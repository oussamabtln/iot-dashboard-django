{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard IoT | Pluie R√©aliste et Nuages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚õàÔ∏è</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. DESIGN G√âN√âRAL --- */
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
            transition: background 1.5s ease;
        }
        h1 { margin-top: 30px; font-weight: 800; text-transform: uppercase; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; }

        /* --- 2. SC√àNE M√âT√âO (ARRI√àRE PLAN) --- */
        .weather-scene {
            position: fixed; top: 50%; left: 5%; transform: translateY(-50%);
            width: 350px; height: 450px; z-index: 90;
            pointer-events: none;
            overflow: hidden; /* Important pour couper la pluie en bas */
        }

        /* ‚òÄÔ∏è SOLEIL */
        .sun {
            position: absolute; top: -40px; right: -40px; width: 100px; height: 100px;
            background: radial-gradient(circle, #f1c40f 40%, #f39c12 80%);
            border-radius: 50%; z-index: 1;
            box-shadow: 0 0 40px #f1c40f, 0 0 80px #f39c12;
            opacity: 0; transform: scale(0.5); transition: all 1s ease;
        }
        .sun::before {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 160%; height: 160%;
            background: repeating-conic-gradient(from 0deg, rgba(255, 255, 255, 0.2) 0deg 10deg, transparent 10deg 20deg);
            border-radius: 50%; animation: sunSpin 20s infinite linear;
        }
        .weather-scene.sunny .sun { opacity: 1; transform: scale(1); }

        /* ‚òÅÔ∏è NUAGES DE BASE */
        .clouds-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; transition: all 1s ease;}
        .cloud {
            position: absolute; width: 80px; height: 80px;
            background: #fff; border-radius: 50%;
            opacity: 0; transition: all 1s ease;
        }
        .cloud::after, .cloud::before { content: ''; position: absolute; background: inherit; border-radius: 50%; }
        .cloud::after { width: 60px; height: 60px; top: -30px; left: 30px; }
        .cloud::before { width: 50px; height: 50px; top: 10px; left: 60px; }

        /* Positions SANS pluie (dispers√©s) */
        .c1 { top: 20px; left: -150px; transform: scale(1); }
        .c2 { top: 100px; left: -150px; transform: scale(0.7); }
        .c3 { top: 60px; left: -150px; transform: scale(0.6); }
        .c4 { top: 30px; left: -200px; transform: scale(0.8); }
        .c5 { top: 110px; left: -180px; transform: scale(0.5); z-index: 4;}
        .c6 { top: 70px; left: -220px; transform: scale(0.7); }
        .c7 { top: -10px; left: -250px; transform: scale(0.9); }
        .c8 { top: 130px; left: -210px; transform: scale(0.6); z-index: 4; }
        .c9 { top: 45px; left: -280px; transform: scale(0.75); }
        .c10 { top: 90px; left: -300px; transform: scale(0.65); }

        /* Animation Nuages Normaux */
        .weather-scene.cloudy .cloud { opacity: 0.9; animation: drift 45s infinite linear; background: #fff; }
        /* D√©lais pour √©taler les nuages */
        .weather-scene.cloudy .c1 { animation-delay: -5s; } .weather-scene.cloudy .c2 { animation-delay: -15s; } .weather-scene.cloudy .c3 { animation-delay: -25s; } .weather-scene.cloudy .c4 { animation-delay: -10s; } .weather-scene.cloudy .c5 { animation-delay: -30s; } .weather-scene.cloudy .c6 { animation-delay: -20s; } .weather-scene.cloudy .c7 { animation-delay: -35s; } .weather-scene.cloudy .c8 { animation-delay: -40s; } .weather-scene.cloudy .c9 { animation-delay: -8s; } .weather-scene.cloudy .c10 { animation-delay: -22s; }

        /* === MODIFICATION POUR PLUIE === */
        .weather-scene.rainy .cloud {
            opacity: 1;
            background: #636e72; /* Gris orage */
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.4));
            animation: none;
            left: 50% !important;
        }

        /* Repositionnement des nuages de base pour former une masse */
        .weather-scene.rainy .c1 { top: 40px; margin-left: -120px; transform: scale(1.2); z-index: 6;}
        .weather-scene.rainy .c2 { top: 60px; margin-left: -40px; transform: scale(1.1); z-index: 7;}
        .weather-scene.rainy .c3 { top: 40px; margin-left: 20px; transform: scale(1.3); z-index: 6;}
        .weather-scene.rainy .c4 { top: 20px; margin-left: -80px; transform: scale(1); z-index: 5;}
        .weather-scene.rainy .c5 { top: 70px; margin-left: 60px; transform: scale(0.9); z-index: 5;}
        .weather-scene.rainy .c6 { top: 30px; margin-left: 0px; transform: scale(1.4); z-index: 8;}
        .weather-scene.rainy .c7 { top: 50px; margin-left: -160px; transform: scale(0.8); }
        .weather-scene.rainy .c8 { top: 80px; margin-left: -20px; transform: scale(1); z-index: 4;}
        .weather-scene.rainy .c9 { top: 20px; margin-left: 80px; transform: scale(1.1); }
        .weather-scene.rainy .c10{ top: 60px; margin-left: 100px; transform: scale(0.9); }

        /* üåßÔ∏èüå®Ô∏è PARTICULES (MODIFI√â POUR VENIR DES NUAGES) */
        .weather-particles {
            position: absolute;
            top: 120px; /* D√âBUT DE LA PLUIE */
            left: 0;
            width: 100%;
            height: calc(100% - 120px);
            z-index: 4;
        }
        .particle { position: absolute; pointer-events: none; }

        /* Style Pluie */
        .weather-scene.rainy .particle {
            width: 3px; height: 15px; background: #a4b0be;
            border-radius: 2px; animation: rainFall 0.6s infinite linear;
            opacity: 0.8;
        }
        /* Style Neige */
        .weather-scene.snowy .particle {
            width: 8px; height: 8px; background: white; border-radius: 50%;
            box-shadow: 0 0 5px white; animation: snowFall 4s infinite linear;
        }

        /* --- NOUVEAU : NUAGES AVANT-PLAN POUR CACHER LA SOURCE DE PLUIE --- */
        .foreground-clouds {
            position: absolute;
            top: 90px; /* Positionn√© juste au-dessus du d√©but de la pluie */
            left: 0;
            width: 100%;
            height: 60px;
            z-index: 10; /* Devant la pluie */
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none;
        }
        .weather-scene.rainy .foreground-clouds {
            opacity: 1;
        }
        /* Style des nuages avant-plan (identique aux nuages de pluie) */
        .foreground-clouds .cloud {
            background: #636e72;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            animation: none;
        }
        /* Positions des nuages avant-plan pour boucher le haut */
        .fc1 { top: 0; left: 10%; transform: scale(1.1); }
        .fc2 { top: 10px; left: 35%; transform: scale(0.9); }
        .fc3 { top: -5px; left: 60%; transform: scale(1.2); }
        .fc4 { top: 15px; left: 80%; transform: scale(1); }


        /* --- 3. PERSONNAGE (AVANT PLAN) --- */
        .character-container {
            position: fixed; top: 50%; left: 5%; transform: translateY(-50%);
            width: 300px; height: 450px; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* BLOB */
        .blob {
            width: 150px; height: 150px; background: #2ecc71; border-radius: 50%;
            position: relative; transition: all 0.5s ease;
            box-shadow: inset -10px -10px 0 rgba(0,0,0,0.1), 0 20px 30px rgba(0,0,0,0.15); z-index: 2;
        }
        .face { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; z-index: 10; }
        .eyes { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
        .eye { width: 15px; height: 15px; background: #333; border-radius: 50%; animation: blink 4s infinite; }
        .mouth { width: 30px; height: 15px; background: #333; border-radius: 0 0 30px 30px; margin: 0 auto; transition: 0.3s; }
        .arm { position: absolute; width: 35px; height: 50px; background: inherit; border-radius: 20px; top: 60%; transition: all 0.5s ease; z-index: 5; }
        .arm.left { left: -15px; transform: rotate(20deg); transform-origin: top right; }
        .arm.right { right: -15px; transform: rotate(-20deg); transform-origin: top left; }

        /* Accessoires */
        .umbrella { position: absolute; top: -80px; right: -50px; opacity: 0; transform: scale(0); transform-origin: bottom left; transition: all 0.5s ease; z-index: 1; }
        .umbrella-canopy { width: 120px; height: 60px; background: #e74c3c; border-radius: 60px 60px 0 0; position: relative; }
        .umbrella-canopy::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid #c0392b; }
        .umbrella-handle { width: 6px; height: 80px; background: #333; margin: 0 auto; position: relative; top: -1px; }
        .umbrella-handle::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 20px; height: 20px; border: 6px solid #333; border-top: none; border-left: none; border-radius: 0 0 15px 0; }
        .fire-container { position: absolute; top: -30px; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.5s; }
        .flame { position: absolute; bottom: 50%; left: 50%; width: 20px; height: 20px; background: radial-gradient(circle, #f1c40f 20%, #e67e22 60%, #e74c3c 100%); border-radius: 50% 0 50% 50%; transform: rotate(-45deg); opacity: 0; }
        .f1 { left: 30%; animation-delay: 0s; } .f2 { left: 50%; width: 30px; height: 30px; animation-delay: 0.2s; } .f3 { left: 70%; animation-delay: 0.4s; }

        /* --- √âTATS --- */
        .blob.hot { background: linear-gradient(to top, #e74c3c, #f39c12); border-radius: 45% 45% 55% 55%; height: 145px; width: 155px; animation: panting 0.8s infinite alternate; }
        .blob.hot .mouth { height: 25px; border-radius: 50%; width: 25px; margin-top: 5px; background: #8e0000;}
        .blob.hot .arm.right { animation: wipeSweat 1.5s infinite ease-in-out; height: 60px; right: 10px; top: 40%; }
        .blob.hot .fire-container { opacity: 1; } .blob.hot .flame { animation: burnRising 1.5s infinite ease-out; }
        .blob.cold { background: #3498db; border-radius: 10px; box-shadow: inset 0 0 20px rgba(255,255,255,0.7); animation: shiver 0.1s infinite; }
        .blob.cold .mouth { width: 20px; height: 5px; border-radius: 2px; background: white; border: 2px solid #333; }
        .blob.cold .arm.left { left: 30px; top: 50%; transform: rotate(-45deg); height: 60px; z-index: 7;}
        .blob.cold .arm.right { right: 30px; top: 50%; transform: rotate(45deg); height: 60px; z-index: 8;}
        .blob.wet { background: #2980b9; animation: floating 3s ease-in-out infinite; }
        .blob.wet .arm.right { height: 55px; top: 45%; right: -20px; transform: rotate(-30deg); }
        .blob.wet .umbrella { opacity: 1; animation: openUmbrella 0.6s forwards; }
        .blob.normal, .blob.tanning { animation: bounce 2s infinite; }
        .blob.normal .arm.right { animation: waveHello 1s infinite ease-in-out; top: 40%; right: -20px; }

        /* --- ANIMATIONS --- */
        @keyframes sunSpin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes drift { from { left: -350px; } to { left: 120%; } }
        /* Animation Pluie */
        @keyframes rainFall {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(400px); opacity: 0; }
        }
        /* Animation Neige */
        @keyframes snowFall {
            0% { transform: translateY(0) rotate(0deg); background: #fff; opacity: 1;}
            100% { transform: translateY(400px) rotate(360deg); background: #ccc; opacity: 0;}
        }
        @keyframes burnRising { 0% { transform: translateY(0) rotate(-45deg) scale(0.8); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-60px) rotate(-20deg) scale(1.2); opacity: 0; } }
        @keyframes openUmbrella { 0% { transform: scale(0) rotate(90deg); opacity: 0; } 100% { transform: scale(1) rotate(-10deg); opacity: 1; } }
        @keyframes wipeSweat { 0% { transform: rotate(-20deg) top: 50% right: -15px; } 40% { transform: rotate(-120deg) top: -10px right: 20px; } 100% { transform: rotate(-20deg) top: 50% right: -15px; } }
        @keyframes waveHello { 0% { transform: rotate(20deg); } 50% { transform: rotate(60deg); } 100% { transform: rotate(20deg); } }
        @keyframes blink { 0%, 96%, 100% { transform: scaleY(1); } 98% { transform: scaleY(0.1); } }
        @keyframes shiver { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 0); } 75% { transform: translate(2px, 0); } }
        @keyframes panting { from { transform: scale(1); } to { transform: scale(1.05); } }
        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* UI */
        .char-bubble { background: white; padding: 10px 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-weight: bold; position: relative; top: -20px; transition: 0.3s; white-space: nowrap; z-index: 20; }
        .char-bubble::after { content: ''; position: absolute; bottom: -10px; left: 50%; border-width: 10px 10px 0; border-style: solid; border-color: white transparent; transform: translateX(-50%); }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-top: 40px; max-width: 900px; margin-left: 300px; }
        .card { background: white; border-radius: 25px; padding: 30px; width: 280px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .value { font-size: 3.5rem; font-weight: 800; margin: 10px 0; }
        .trend { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
        .btn-graph { display: block; margin-top: 20px; padding: 10px; background: #333; color: white; border-radius: 50px; text-decoration: none; font-weight: bold; }
        .footer { margin-top: auto; margin-bottom: 20px; font-size: 0.8rem; color: #7f8c8d; margin-left: 300px; }

        @media (max-width: 950px) { .weather-scene { position: relative; top: 0; left: 0; transform: none; width: 100%; height: 300px; margin-bottom: 20px; } .character-container { position: relative; top: 0; left: 0; transform: none; width: 100%; height: auto; margin-bottom: 40px; } .container { margin-left: 0; } .footer { margin-left: 0; color: #333;} body { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%) !important; } }
    </style>
</head>
<body>

    <h1><i class="fas fa-microchip"></i> Dashboard IoT</h1>

    <div class="weather-scene" id="weatherScene">
        <div class="sun"></div>

        <div class="clouds-container">
            <div class="cloud c1"></div>
            <div class="cloud c2"></div>
            <div class="cloud c3"></div>
            <div class="cloud c4"></div>
            <div class="cloud c5"></div>
            <div class="cloud c6"></div>
            <div class="cloud c7"></div>
            <div class="cloud c8"></div>
            <div class="cloud c9"></div>
            <div class="cloud c10"></div>
        </div>

        <div class="weather-particles" id="weatherParticles"></div>

        <div class="foreground-clouds">
            <div class="cloud fc1"></div>
            <div class="cloud fc2"></div>
            <div class="cloud fc3"></div>
            <div class="cloud fc4"></div>
        </div>
    </div>

    <div class="character-container">
        <div id="char-bubble-text" class="char-bubble">Initialisation...</div>

        <div id="blob-character" class="blob normal">
            <div class="fire-container"><div class="flame f1"></div><div class="flame f2"></div><div class="flame f3"></div></div>
            <div class="umbrella"><div class="umbrella-canopy"></div><div class="umbrella-handle"></div></div>
            <div class="arm left"></div><div class="arm right"></div>
            <div class="face"><div class="eyes"><div class="eye left"></div><div class="eye right"></div></div><div class="mouth"></div></div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2 style="color:#e74c3c">Temp√©rature</h2>
            <div class="value" style="color:#e74c3c"><span id="temp">--</span>¬∞C</div>
            <div id="trend-temp" class="trend">--</div>
            <a href="/graph-temp/" class="btn-graph">Historique</a>
        </div>

        <div class="card">
            <h2 style="color:#3498db">Humidit√©</h2>
            <div class="value" style="color:#3498db"><span id="hum">--</span>%</div>
            <div id="trend-hum" class="trend">--</div>
            <a href="/graph-hum/" class="btn-graph">Historique</a>
        </div>
    </div>

    <div class="footer">Projet IoT ‚Ä¢ M√©t√©o R√©aliste</div>

    <script>
        const API_URL_LATEST = "/latest/";
        const tempElement = document.getElementById('temp');
        const humElement  = document.getElementById('hum');
        const trendTempEl = document.getElementById('trend-temp');
        const trendHumEl  = document.getElementById('trend-hum');
        const blob        = document.getElementById('blob-character');
        const blobBubble  = document.getElementById('char-bubble-text');

        const weatherScene = document.getElementById('weatherScene');
        const weatherParticles = document.getElementById('weatherParticles');

        function createParticles(type, count) {
            weatherParticles.innerHTML = '';
            for (let i = 0; i < count; i++) {
                let p = document.createElement('div');
                p.className = 'particle';
                // Position al√©atoire sur la largeur
                p.style.left = Math.random() * 100 + '%';
                // Vitesse et d√©lai al√©atoires
                p.style.animationDuration = (Math.random() * 0.8 + 0.5) + 's';
                p.style.animationDelay = Math.random() * 2 + 's';
                weatherParticles.appendChild(p);
            }
        }

        async function updateDashboard() {
          try {
            const response = await fetch(API_URL_LATEST);
            if (!response.ok) throw new Error("Erreur API");
            const data = await response.json();

            const t = (data.temperature !== undefined) ? data.temperature : data.temp;
            const h = (data.humidity !== undefined)    ? data.humidity    : data.hum;
            const pt = data.prev_temp;
            const ph = data.prev_hum;

            if (tempElement) tempElement.textContent = t;
            if (humElement)  humElement.textContent = h;

            updateTrend(trendTempEl, t, pt, "¬∞C");
            updateTrend(trendHumEl, h, ph, "%");
            updateWeatherAndMood(t, h);

          } catch (error) {
            console.error("Erreur:", error);
            if (blobBubble) blobBubble.innerText = "Pas de signal...";
            if (blob) blob.className = "blob cold";
          }
        }

        function updateWeatherAndMood(temp, hum) {
            if (!blob) return;
            blob.className = "blob";
            weatherScene.className = 'weather-scene'; // Reset classes m√©t√©o
            weatherParticles.innerHTML = ''; // Stop pluie/neige

            // Ciel bleu par d√©faut
            document.body.style.background = 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)';

            let text = "Tout va bien !";

            // 1. NEIGE (Froid < 5¬∞C)
            if (temp <= 5) {
                blob.classList.add('cold');
                weatherScene.classList.add('snowy');
                createParticles('snow', 60);
                text = "Brrr... Il neige ! üå®Ô∏è";
                document.body.style.background = 'linear-gradient(135deg, #e6dada 0%, #274046 100%)';
            }
            // 2. FEU (Chaud > 35¬∞C)
            else if (temp >= 35) {
                blob.classList.add('hot');
                weatherScene.classList.add('sunny');
                text = "AU SECOURS ! üî•";
                document.body.style.background = 'linear-gradient(135deg, #ff4e50 0%, #f9d423 100%)';
            }
            // 3. PLUIE (Humide > 75%)
            else if (hum >= 75) {
                blob.classList.add('wet');
                weatherScene.classList.add('rainy'); // Nuages Gris Compacts
                createParticles('rain', 100); // Pluie r√©aliste
                text = "Il pleut ! ‚òî";
                document.body.style.background = 'linear-gradient(135deg, #4b6cb7 0%, #182848 100%)';
            }
            // 4. BEAU TEMPS (Chaud & Sec)
            else if (temp >= 25 && hum < 50) {
                blob.classList.add('tanning');
                weatherScene.classList.add('sunny');
                weatherScene.classList.add('cloudy');
                text = "Ah... Le soleil ! üòé";
                document.body.style.background = 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)';
            }
            // 5. NORMAL
            else {
                blob.classList.add('normal');
                weatherScene.classList.add('cloudy');
                text = "Salut ! La vie est belle.";
            }

            if (blobBubble) blobBubble.innerText = text;
        }

        function updateTrend(el, cur, prev, unit) {
            if (!el || prev == null) return;
            let icon = '=';
            if (cur > prev) icon = '‚¨Ü';
            else if (cur < prev) icon = '‚¨á';
            el.innerHTML = `${icon} Prev: ${prev}${unit}`;
        }

        setInterval(updateDashboard, 2000);
        updateDashboard();
    </script>
</body>
</html>