{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>IoT Factory Supervision | Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {# <link rel="icon" href="{% static 'img/favicon.png' %}"> #}

  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg-gradient: radial-gradient(circle at center, #1e293b, #0f172a, #000000);
      --text-main: #f8fafc;
      --text-sub: #94a3b8;
      --card-bg: rgba(30, 41, 59, 0.6);
      --card-border: rgba(255,255,255,0.08);
      --shadow-color: rgba(0,0,0,0.4);
      --input-bg: rgba(0,0,0,0.4);
      --modal-bg: #1e293b;
      --op-bg: rgba(0,0,0,0.5);
    }
    .light-mode {
      --bg-gradient: radial-gradient(circle at center, #ffffff, #f1f5f9, #cbd5e1);
      --text-main: #1e293b;
      --text-sub: #475569;
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(0,0,0,0.1);
      --shadow-color: rgba(0,0,0,0.1);
      --input-bg: rgba(255,255,255,0.9);
      --modal-bg: #f8fafc;
      --op-bg: rgba(255,255,255,0.5);
    }

    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--bg-gradient);
      background-size:400% 400%;
      animation:gradientBG 15s ease infinite;
      color:var(--text-main);
      margin:0; padding:20px;
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh; overflow-x:hidden; position:relative;
      transition:color .5s, background .5s;
    }
    @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    body::before{
      content:""; position:absolute; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 5 L55 5 L55 55 L5 55 Z' fill='none' stroke='rgba(100, 100, 100, 0.05)' stroke-width='1'/%3E%3C/svg%3E");
      pointer-events:none; z-index:-1;
    }

    .theme-switch{
      position:absolute; top:20px; right:20px; z-index:1000;
      background:var(--card-bg); border:1px solid var(--text-sub);
      color:var(--text-main); padding:10px 15px; border-radius:30px;
      cursor:pointer; font-family:'Rajdhani'; font-weight:bold;
      transition:.3s; backdrop-filter: blur(5px);
    }
    .theme-switch:hover{transform:scale(1.1); box-shadow:0 0 15px var(--shadow-color)}
    h1{
      font-family:'Rajdhani',sans-serif; text-transform:uppercase; letter-spacing:4px;
      background:linear-gradient(90deg,#3498db,#f39c12);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      margin:10px 0 15px; font-size:2.8rem;
      text-shadow:0 0 30px rgba(52,152,219,.4); z-index:10;
    }

    .status-bar{
      width:100%;
      max-width: 1100px;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      margin: 0 0 18px;
      z-index:20;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius: 999px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 10px 25px var(--shadow-color);
      backdrop-filter: blur(10px);
      font-family:'Rajdhani';
      font-weight: 800;
      letter-spacing: .5px;
      color: var(--text-main);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:#94a3b8;
      box-shadow: 0 0 12px rgba(148,163,184,.35);
    }
    .dot.ok{ background:#22c55e; box-shadow:0 0 14px rgba(34,197,94,.35); }
    .dot.bad{ background:#ef4444; box-shadow:0 0 14px rgba(239,68,68,.35); }
    .dot.warn{ background:#f59e0b; box-shadow:0 0 14px rgba(245,158,11,.35); }

    .btn-mini{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius: 999px;
      font-family:'Rajdhani';
      font-weight: 900;
      letter-spacing: .8px;
      background: rgba(125,125,125,.12);
      color: var(--text-main);
      border: 1px solid var(--text-sub);
      transition:.2s;
    }
    .btn-mini:hover{ transform: translateY(-2px); box-shadow:0 12px 20px var(--shadow-color); background: var(--text-main); color: var(--modal-bg); }

    .toast-stack{
      width:95%;
      max-width: 900px;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin: 8px 0 18px;
      z-index: 70;
    }
    .toast{
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 10px 30px var(--shadow-color);
      border-radius: 18px;
      padding: 14px 16px;
      backdrop-filter: blur(12px);
      font-family:'Rajdhani';
      font-weight: 800;
      letter-spacing: .5px;
    }
    .toast.success{ border-color: rgba(34,197,94,.5); }
    .toast.error{ border-color: rgba(239,68,68,.5); }
    .toast.warning{ border-color: rgba(245,158,11,.55); }

    .operators-panel{display:flex; gap:20px; margin-bottom:15px; width:100%; max-width:900px; justify-content:center;}
    .op-box{
      background:var(--op-bg); border:1px solid var(--text-sub);
      padding:12px 20px; border-radius:12px; color:var(--text-sub);
      font-family:'Rajdhani'; font-weight:bold; transition:.3s; display:none;
    }
    .op-active{
      display:block; animation:flashOp 1s infinite alternate;
      background:rgba(231,76,60,.2); border-color:#e74c3c; color:#e74c3c;
      box-shadow:0 0 15px rgba(231,76,60,.4);
    }
    @keyframes flashOp{from{opacity:.7}to{opacity:1}}

    .alerts-stack{
      width: 95%;
      max-width: 1200px;
      display: none;
      gap: 18px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px 0 25px;
      z-index: 50;
    }

    .alert-card{
      width: 360px;
      background: linear-gradient(135deg, #991b1b, #7f1d1d);
      border: 2px solid #ef4444;
      box-shadow: 0 0 40px rgba(239,68,68,.35);
      padding: 18px 18px 16px;
      border-radius: 24px;
      position: relative;
      color: white;
      backdrop-filter: blur(10px);
      animation: pulse .9s infinite alternate;
    }
    @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.01)}}

    .alert-close{
      position:absolute;
      top:12px; right:12px;
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.45);
      background: rgba(0,0,0,.25);
      color:#fff;
      font-size:18px;
      cursor:pointer;
      transition:.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .alert-close:hover{transform:scale(1.06); background: rgba(255,255,255,.15);}

    .alert-head{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 8px;
      font-family:'Rajdhani';
    }
    .alert-role{
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: 1px;
      opacity: .95;
    }
    .alert-counter{
      font-family:'Rajdhani';
      font-size: 1.0rem;
      border: 1px solid rgba(255,255,255,.6);
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.15);
    }

    .alert-msg{ font-weight: 800; font-size: 1.15rem; margin: 8px 0 6px; }
    .alert-status{ font-size: .95rem; color: #ffd1d1; margin-bottom: 10px; min-height: 18px; }

    .alert-form{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top: 8px;
    }
    .alert-form input[type="text"]{
      width: 92%;
      padding: 12px;
      border-radius: 16px;
      border: none;
      text-align: center;
      outline: none;
    }
    .alert-form button{
      width: 92%;
      background: white;
      color: #b91c1c;
      border:none;
      padding: 12px 16px;
      border-radius: 18px;
      font-weight: 900;
      cursor:pointer;
      font-family:'Rajdhani';
      font-size: 1.05rem;
      transition:.2s;
    }
    .alert-form button:hover{transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.25)}

    .ack-banner{
      width: 95%;
      max-width: 900px;
      display:none;
      background: rgba(46, 204, 113, .15);
      border: 1px solid rgba(46, 204, 113, .45);
      box-shadow: 0 0 30px rgba(46, 204, 113, .2);
      padding: 16px 18px;
      border-radius: 20px;
      margin: 10px 0 25px;
      position: relative;
      z-index: 60;
      backdrop-filter: blur(10px);
    }
    .ack-banner .ack-close{
      position:absolute; top:12px; right:12px;
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(0,0,0,.20);
      color:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:.2s;
    }
    .ack-banner .ack-close:hover{transform:scale(1.06)}
    .ack-title{ font-family:'Rajdhani'; font-weight: 900; font-size: 1.2rem; color:#d1fae5; }
    .ack-sub{opacity:.95; color:#eafff4; margin-top:4px; font-size:.95rem;}

    .cards-container{display:flex; flex-wrap:wrap; justify-content:center; gap:30px; width:100%; max-width:1200px; margin-bottom:30px; z-index:10;}
    .card{
      border-radius:45px; background:var(--card-bg); backdrop-filter: blur(15px);
      border:1px solid var(--card-border);
      padding:30px; width:280px; text-align:center;
      box-shadow:0 15px 35px var(--shadow-color);
      transition: all .35s;
    }
    .card:hover{transform:translateY(-10px) scale(1.02)}
    .card-icon{font-size:3.5rem; margin-bottom:10px; animation:iconPulse 2s infinite alternate;}
    @keyframes iconPulse{0%{filter:drop-shadow(0 0 2px currentColor)}100%{filter:drop-shadow(0 0 15px currentColor)}}
    .card-val{font-family:'Rajdhani',sans-serif; font-size:4rem; font-weight:700; margin:5px 0; letter-spacing:2px;}
    .card-lbl{text-transform:uppercase; color:var(--text-sub); font-weight:600; font-size:.85rem; letter-spacing:2px; margin-bottom:15px;}
    .c-temp{border-bottom:6px solid #e67e22}.c-temp .card-val,.c-temp .card-icon{color:#e67e22;filter:drop-shadow(0 0 10px #e67e22)}
    .c-hum{border-bottom:6px solid #3498db}.c-hum .card-val,.c-hum .card-icon{color:#3498db;filter:drop-shadow(0 0 10px #3498db)}
    .c-alert{border-bottom:6px solid #e74c3c}.c-alert .card-val,.c-alert .card-icon{color:#e74c3c;filter:drop-shadow(0 0 15px #e74c3c)}
    .btn-link{
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
      padding:10px 25px; border-radius:30px;
      text-decoration:none; font-weight:bold; font-size:.9rem;
      background: rgba(125,125,125,.1); color:var(--text-main);
      border:1px solid var(--text-sub); transition:.3s; font-family:'Rajdhani'; letter-spacing:1px;
    }
    .btn-link:hover{background:var(--text-main); color:var(--modal-bg);}

    .test-box{
      background:var(--card-bg); border:1px solid var(--card-border);
      padding:20px 40px; border-radius:50px; display:flex; gap:15px; align-items:center; justify-content:center;
      margin-bottom:25px; z-index:10; backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .inp-num{
      background:var(--input-bg); border:1px solid var(--text-sub); color:var(--text-main);
      padding:12px; border-radius:15px; width:110px; text-align:center;
      font-family:'Rajdhani'; font-size:1.2rem;
    }
    .btn-go{
      background:linear-gradient(45deg,#8e44ad,#9b59b6); color:white; border:none;
      padding:12px 30px; border-radius:30px; cursor:pointer; font-weight:bold;
      font-family:'Rajdhani'; transition:.3s;
    }
    .btn-go:hover{transform:scale(1.05); box-shadow:0 0 20px #9b59b6}

    .robot-wrapper{position:fixed; bottom:30px; right:30px; width:240px; height:260px; cursor:pointer; z-index:100; filter:drop-shadow(0 15px 30px var(--shadow-color)); transition:transform .3s;}
    .robot-wrapper:hover{transform:scale(1.05)}
    .bubble{
      position:absolute; top:-70px; right:20px; background:var(--card-bg);
      color:var(--text-main); padding:15px 25px; border-radius:30px 30px 0 30px; font-weight:800;
      opacity:0; transition:.4s; pointer-events:none; white-space:nowrap;
      box-shadow:0 10px 30px var(--shadow-color); border:3px solid #3498db;
      font-family:'Rajdhani'; font-size:1.1rem;
    }
    .eye-wrapper{cursor:pointer}.closed-eye{display:none}
    .eye-wrapper:hover .open-eye{display:none}.eye-wrapper:hover .closed-eye{display:block}
    .scanner-beam{animation:scan 3s linear infinite}
    @keyframes scan{0%{transform:translateX(-70px);opacity:0}50%{opacity:1}100%{transform:translateX(70px);opacity:0}}
    #sunglasses,#ice-cap,#teeth{display:none;transition:.5s}
    .robot-alert #body-group{animation:shake .3s infinite}
    .robot-alert .screen-bg{fill:#7f1d1d !important; filter:url(#glow-red)}
    .robot-alert .eye-glow{fill:#ef4444 !important; filter:url(#glow-red)}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px) rotate(-3deg)}75%{transform:translateX(4px) rotate(3deg)}}
    .robot-cold #sunglasses,.robot-cold #ice-cap{display:block}
    .robot-cold .eyes-group-container{opacity:0}
    .robot-cold .screen-bg{fill:#1e3a8a !important;}
    .robot-frozen-ack .screen-bg{fill:#bae6fd !important}
    .robot-frozen-ack #mouth{display:none}
    .robot-frozen-ack #teeth{display:block}
    .robot-frozen-ack #body-group{animation:shiver .2s infinite}
    @keyframes shiver{0%{transform:translateX(0)}50%{transform:translateX(2px)}100%{transform:translateX(0)}}
    .body-alert{background:radial-gradient(circle at center,#7f1d1d,#450a0a) !important; animation:none !important; color:white !important;}
    .body-cold{background:radial-gradient(circle at center,#172554,#0f172a) !important; animation:none !important; color:white !important;}

    .btn-action{
      background:var(--card-bg); border:2px solid; padding:12px 25px; border-radius:50px; cursor:pointer;
      font-family:'Rajdhani'; font-weight:700; font-size:1rem; text-decoration:none;
      display:flex; align-items:center; gap:10px; transition:.3s; backdrop-filter: blur(5px);
      color:inherit;
    }
    .btn-action:hover{transform:translateY(-5px); background:var(--text-main); color:var(--modal-bg) !important; box-shadow:0 5px 20px var(--shadow-color);}

    /* ‚úÖ MENU (hamburger) */
    .menu-btn{
      position:fixed;
      top:20px;
      left:20px;
      z-index:1200;
      width:46px; height:46px;
      border-radius:16px;
      border:1px solid var(--card-border);
      background:var(--card-bg);
      color:var(--text-main);
      cursor:pointer;
      font-size:20px;
      backdrop-filter: blur(10px);
    }
    .menu-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index:1190;
    }
    .side-menu{
      position:fixed;
      top:0; left:-360px;
      width:320px; height:100vh;
      background: var(--card-bg);
      border-right:1px solid var(--card-border);
      backdrop-filter: blur(16px);
      z-index:1195;
      padding:18px;
      transition:.25s;
    }
    .side-menu.open{ left:0; }
    .side-menu h3{font-family:'Rajdhani'; letter-spacing:2px; margin:0 0 8px;}
    .side-menu .meta{color:var(--text-sub); font-size:.95rem; margin-bottom:14px;}
    .side-menu a, .side-menu button{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:10px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid var(--card-border);
      background: rgba(0,0,0,.22);
      color: var(--text-main);
      text-decoration:none;
      cursor:pointer;
      font-family:'Rajdhani';
      font-weight:800;
    }
    .side-menu input[type="password"]{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--card-border);
      background: var(--input-bg);
      color: var(--text-main);
      margin-top:10px;
      outline:none;
    }
  </style>
</head>

<body>

  <!-- ‚úÖ MENU -->
  <button class="menu-btn" type="button" onclick="openMenu()">‚ò∞</button>
  <div id="menuBackdrop" class="menu-backdrop" onclick="closeMenu()"></div>

  <div id="sideMenu" class="side-menu">
    <h3>Op√©rateur</h3>

    <div class="meta">
      <div><b>{{ request.user.username }}</b></div>
      <div>
        {% if profile %}
          {{ profile.prenom }} {{ profile.nom }} ‚Äî {{ profile.get_niveau_display }}
          {% if profile.telephone %}<br>T√©l: {{ profile.telephone }}{% endif %}
        {% else %}
          (Profil non d√©fini)
        {% endif %}
      </div>
    </div>

    <a href="{% url 'logout' %}"><i class="fas fa-right-from-bracket"></i> Se d√©connecter</a>

    {% if is_directeur %}
      <a href="{% url 'create_operateur' %}"><i class="fas fa-user-plus"></i> Ajouter un compte</a>

      <form method="post" action="{% url 'purge_data' %}" style="margin-top:8px;">
        {% csrf_token %}
        <input type="password" name="password" placeholder="Mot de passe directeur" required>
        <button type="submit" onclick="return confirm('Confirmer la suppression de toutes les donn√©es ?');">
          <i class="fas fa-broom"></i> Vider toutes les donn√©es
        </button>
      </form>
    {% endif %}
  </div>

  <!-- ‚úÖ THEME -->
  <button class="theme-switch" type="button" onclick="toggleTheme()"><i class="fas fa-adjust"></i> MODE JOUR/NUIT</button>

  <h1><i class="fas fa-satellite-dish"></i> IOT FACTORY SUPERVISION</h1>

  <!-- ‚úÖ STATUS BAR -->
  <div class="status-bar">
    <div class="pill">
      <span class="dot" id="netDot"></span>
      <span id="netText">Connexion: ...</span>
    </div>

    <div class="pill">
      <span class="dot warn" id="alarmDot"></span>
      <span id="alarmText">Alarme: ...</span>
    </div>

    <div class="pill">
      <i class="fas fa-clock"></i>
      <span>MAJ: <span id="lastUpdate">--:--:--</span></span>
    </div>

    <button class="btn-mini" type="button" onclick="toggleAlarm()">
      <i class="fas fa-bell"></i> TOGGLE ALARME
    </button>
  </div>

  <!-- ‚úÖ DJANGO MESSAGES -->
  {% if messages %}
    <div class="toast-stack">
      {% for message in messages %}
        <div class="toast {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="operators-panel">
    <div id="op1" class="op-box"><i class="fas fa-user-hard-hat"></i> OP√âRATEUR 1</div>
    <div id="op2" class="op-box"><i class="fas fa-user-tie"></i> CHEF √âQUIPE</div>
    <div id="op3" class="op-box"><i class="fas fa-user-shield"></i> DIRECTEUR</div>
  </div>

  <div id="ackBanner" class="ack-banner">
    <button class="ack-close" type="button" onclick="dismissAckBanner()">‚úï</button>
    <div class="ack-title">‚úÖ Alerte acquitt√©e par <span id="ackBy">---</span></div>
    <div class="ack-sub">L‚Äôincident reste surveill√© tant que la temp√©rature est hors plage.</div>
  </div>

  <div id="alertsStack" class="alerts-stack">

    <!-- OP1 -->
    <div id="alertOp1" class="alert-card">
      <button class="alert-close" type="button" onclick="dismissPanel('op1')">‚úï</button>

      <div class="alert-head">
        <div class="alert-role"><i class="fas fa-user-hard-hat"></i> OP√âRATEUR 1</div>
        <div class="alert-counter">Tentative: <span class="cnt">0</span>/9</div>
      </div>

      <div class="alert-msg" id="msgOp1">‚ö†Ô∏è ALERTE HORS PLAGE</div>
      <div class="alert-status" id="statusOp1">---</div>

      <form class="alert-form" action="{% url 'valider_incident' %}" method="POST" onsubmit="return handleAck(event, 'op1')">
        {% csrf_token %}
        <input type="hidden" name="operator" value="Op√©rateur 1">
        <input type="hidden" class="hiddenCounter" name="compteur_val" value="0">
        <input type="text" name="note" placeholder="Note d'intervention (OP1)">
        <button type="submit"><i class="fas fa-check-circle"></i> ACQUITTER</button>
      </form>
    </div>

    <!-- CHEF -->
    <div id="alertOp2" class="alert-card">
      <button class="alert-close" type="button" onclick="dismissPanel('op2')">‚úï</button>

      <div class="alert-head">
        <div class="alert-role"><i class="fas fa-user-tie"></i> CHEF √âQUIPE</div>
        <div class="alert-counter">Tentative: <span class="cnt">0</span>/9</div>
      </div>

      <div class="alert-msg" id="msgOp2">‚ö†Ô∏è ALERTE NIVEAU 2</div>
      <div class="alert-status" id="statusOp2">---</div>

      <form class="alert-form" action="{% url 'valider_incident' %}" method="POST" onsubmit="return handleAck(event, 'op2')">
        {% csrf_token %}
        <input type="hidden" name="operator" value="Chef √âquipe">
        <input type="hidden" class="hiddenCounter" name="compteur_val" value="0">
        <input type="text" name="note" placeholder="Note d'intervention (Chef)">
        <button type="submit"><i class="fas fa-check-circle"></i> ACQUITTER</button>
      </form>
    </div>

    <!-- DIRECTEUR -->
    <div id="alertOp3" class="alert-card">
      <button class="alert-close" type="button" onclick="dismissPanel('op3')">‚úï</button>

      <div class="alert-head">
        <div class="alert-role"><i class="fas fa-user-shield"></i> DIRECTEUR</div>
        <div class="alert-counter">Tentative: <span class="cnt">0</span>/9</div>
      </div>

      <div class="alert-msg" id="msgOp3">üö® URGENCE NIVEAU 3</div>
      <div class="alert-status" id="statusOp3">---</div>

      <form class="alert-form" action="{% url 'valider_incident' %}" method="POST" onsubmit="return handleAck(event, 'op3')">
        {% csrf_token %}
        <input type="hidden" name="operator" value="Directeur">
        <input type="hidden" class="hiddenCounter" name="compteur_val" value="0">
        <input type="text" name="note" placeholder="Note d'intervention (Directeur)">
        <button type="submit"><i class="fas fa-check-circle"></i> ACQUITTER</button>
      </form>
    </div>

  </div>

  <!-- CARTES -->
  <div class="cards-container">
    <div class="card c-temp">
      <div class="card-icon"><i class="fas fa-thermometer-half"></i></div>
      <div class="card-lbl">Temp√©rature</div>
      <div class="card-val"><span id="temp">--</span>¬∞C</div>
      <a href="{% url 'graph_temp' %}" class="btn-link"><i class="fas fa-chart-area"></i> Voir Courbe</a>
    </div>

    <div class="card c-hum">
      <div class="card-icon"><i class="fas fa-tint"></i></div>
      <div class="card-lbl">Humidit√©</div>
      <div class="card-val"><span id="hum">--</span>%</div>
      <a href="{% url 'graph_hum' %}" class="btn-link"><i class="fas fa-chart-line"></i> Voir Courbe</a>
    </div>

    <div class="card c-alert">
      <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <div class="card-lbl">Total Incidents</div>
      <div class="card-val">{{ nb_incidents }}</div>
    </div>
  </div>

  <!-- SIMULATION -->
  <div class="test-box">
    <span style="font-family:'Rajdhani'; letter-spacing:1px; color:var(--text-sub);"><i class="fas fa-vial"></i> SIMULATION :</span>
    <form action="{% url 'simulation_data' %}" method="POST" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      {% csrf_token %}
      <input type="number" step="any" name="temp" class="inp-num" placeholder="T ¬∞C" required>
      <input type="number" step="any" name="hum" class="inp-num" placeholder="H %" required>
      <button type="submit" class="btn-go">INJECTER</button>
    </form>
  </div>

  <!-- ACTIONS -->
  <div style="display:flex; gap:15px; margin-bottom:50px; flex-wrap:wrap; justify-content:center; z-index:10;">
    <a href="{% url 'csv_dht' %}" class="btn-action" style="border-color:#2ecc71; color:#2ecc71;">
      <i class="fas fa-file-csv"></i> Relev√©s T¬∞/H%
    </a>

    <a href="{% url 'incident_archive' %}" class="btn-action" style="border-color:#3498db; color:#3498db;">
      <i class="fas fa-archive"></i> Archives Incidents
    </a>
  </div>

  <!-- Robot -->
  <div class="robot-wrapper" onclick="helloRobot()">
    <div id="bubble" class="bubble">Syst√®mes Pr√™ts.</div>

    <svg id="robot" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="bodyGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffffff"/><stop offset="1" stop-color="#cbd5e1"/></linearGradient>
        <linearGradient id="darkMetal" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#475569"/><stop offset="1" stop-color="#1e293b"/></linearGradient>
        <filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <filter id="glow-red"><feGaussianBlur stdDeviation="5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <linearGradient id="scanGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:rgba(52, 152, 219, 0)" />
          <stop offset="50%" style="stop-color:rgba(52, 152, 219, 0.8)" />
          <stop offset="100%" style="stop-color:rgba(52, 152, 219, 0)" />
        </linearGradient>
      </defs>

      <g id="body-group">
        <rect x="95" y="10" width="10" height="30" fill="url(#darkMetal)"/>
        <circle cx="100" cy="15" r="8" fill="#f1c40f" stroke="url(#darkMetal)" stroke-width="2" filter="url(#glow)"/>
        <path d="M50,60 C50,30 150,30 150,60 L150,140 C150,170 130,200 100,200 C70,200 50,170 50,140 Z" fill="url(#bodyGrad)" stroke="url(#darkMetal)" stroke-width="6"/>
        <rect class="screen-bg" x="65" y="70" width="70" height="50" rx="10" fill="#1e293b" stroke="#334155" stroke-width="2"/>
        <rect class="scanner-beam" x="65" y="70" width="5" height="50" fill="url(#scanGrad)" clip-path="inset(0 0 0 0 round 10px)" />
        <g class="eyes-group-container">
          <g class="eye-wrapper" id="eye-L">
            <g class="open-eye">
              <circle class="eye-glow" cx="82" cy="95" r="10" fill="#f1c40f" filter="url(#glow)"/>
              <circle id="pupil-L" cx="82" cy="95" r="3" fill="#1e293b"/>
            </g>
            <path class="closed-eye eye-glow" d="M72,95 Q82,105 92,95" fill="none" stroke="#f1c40f" stroke-width="3" stroke-linecap="round" filter="url(#glow)"/>
          </g>
          <g class="eye-wrapper" id="eye-R">
            <g class="open-eye">
              <circle class="eye-glow" cx="118" cy="95" r="10" fill="#f1c40f" filter="url(#glow)"/>
              <circle id="pupil-R" cx="118" cy="95" r="3" fill="#1e293b"/>
            </g>
            <path class="closed-eye eye-glow" d="M108,95 Q118,105 128,95" fill="none" stroke="#f1c40f" stroke-width="3" stroke-linecap="round" filter="url(#glow)"/>
          </g>
        </g>
        <path id="mouth" d="M85,110 Q100,115 115,110" fill="none" stroke="#f1c40f" stroke-width="3" stroke-linecap="round" filter="url(#glow)"/>
        <g id="teeth" fill="white" stroke="none">
          <path d="M85,108 h30 v6 h-30 z" />
          <path d="M85,116 h30 v6 h-30 z" />
          <path d="M95,108 v14 M105,108 v14" stroke="#ccc" stroke-width="1"/>
        </g>
        <path d="M45,120 C30,130 30,160 55,170" fill="url(#bodyGrad)" style="filter: drop-shadow(-3px 3px 3px rgba(0,0,0,0.3));"/>
        <path d="M155,120 C170,130 170,160 145,170" fill="url(#bodyGrad)" style="filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.3));"/>
      </g>

      <g id="sunglasses">
        <rect x="60" y="82" width="35" height="25" rx="5" fill="#111" stroke="#fff"/>
        <rect x="105" y="82" width="35" height="25" rx="5" fill="#111" stroke="#fff"/>
        <line x1="95" y1="95" x2="105" y2="95" stroke="#fff" stroke-width="2"/>
      </g>

      <path id="ice-cap" d="M60,55 Q100,35 140,55 L140,70 Q130,80 120,70 Q110,85 100,70 Q90,80 80,70 Q70,85 60,70 Z" fill="#dff9fb" stroke="#3498db" stroke-width="2" filter="drop-shadow(0 0 5px #3498db)"/>
    </svg>
  </div>

  <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" loop></audio>

  <script>
    const THEME_KEY = "theme_mode";

    /* ‚úÖ IMPORTANT: utiliser les URL Django (pas des strings hardcod√©es) */
    const API_URL = "{% url 'latest_json' %}";
    const TOGGLE_ALARM_URL = "{% url 'toggle_alarm' %}";

    const MIN_OK = 2.0;
    const MAX_OK = 8.0;

    const body = document.body;
    const alarmSound = document.getElementById("alarm-sound");

    // WhatsApp (optionnel)
    const WA_PHONE = "{{ WA_PHONE|default:'+212000000000' }}";
    const WA_KEY   = "{{ WA_KEY|default:'YOUR_KEY' }}";

    let activeAlert = false;
    let currentIncidentId = null;

    const netDot = document.getElementById("netDot");
    const netText = document.getElementById("netText");
    const alarmDot = document.getElementById("alarmDot");
    const alarmText = document.getElementById("alarmText");
    const lastUpdate = document.getElementById("lastUpdate");

    function applySavedTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "light") body.classList.add("light-mode");
      if (saved === "dark") body.classList.remove("light-mode");
    }
    applySavedTheme();

    function toggleTheme(){
      body.classList.toggle("light-mode");
      localStorage.setItem(THEME_KEY, body.classList.contains("light-mode") ? "light" : "dark");
    }

    function sendWhatsApp(msg){
      const url = `https://api.callmebot.com/whatsapp.php?phone=${WA_PHONE}&text=${encodeURIComponent(msg)}&apikey=${WA_KEY}`;
      new Image().src = url;
    }

    function resetOps(){
      document.querySelectorAll(".op-box").forEach(el => el.classList.remove("op-active"));
    }

    function showBubble(t, c){
      const b = document.getElementById("bubble");
      b.innerText = t;
      b.style.borderColor = c;
      b.style.opacity = 1;
    }
    function hideBubble(){ document.getElementById("bubble").style.opacity = 0; }

    function helloRobot(){
      const bot = document.getElementById("robot");
      if (bot.classList.contains("robot-cold")) showBubble("Mode Hiver. ‚ùÑÔ∏è", "#3498db");
      else if (bot.classList.contains("robot-alert")) showBubble("ALERTE ! üî•", "#e74c3c");
      else showBubble("Syst√®me nominal. ‚úÖ", "#3498db");

      setTimeout(() => {
        if (!activeAlert && !bot.classList.contains("robot-cold")) hideBubble();
      }, 2000);
    }

    document.addEventListener("mousemove", e => {
      if (document.getElementById("robot").classList.contains("robot-cold")) return;
      const pupils = [document.getElementById("pupil-L"), document.getElementById("pupil-R")];
      pupils.forEach(pupil => {
        const eye = pupil.previousElementSibling;
        const rect = eye.getBoundingClientRect();
        const x = Math.max(-3.5, Math.min(3.5, (e.clientX - (rect.left + rect.width/2)) / 20));
        const y = Math.max(-3.5, Math.min(3.5, (e.clientY - (rect.top + rect.height/2)) / 20));
        pupil.style.transform = `translate(${x}px, ${y}px)`;
      });
    });

    function dismissPanel(which){
      if (!currentIncidentId) return;
      sessionStorage.setItem(`hide_${currentIncidentId}_${which}`, "1");
      document.getElementById(which === "op1" ? "alertOp1" : which === "op2" ? "alertOp2" : "alertOp3").style.display = "none";
    }

    function dismissAckBanner(){
      if (!currentIncidentId) return;
      sessionStorage.setItem(`hide_ack_${currentIncidentId}`, "1");
      document.getElementById("ackBanner").style.display = "none";
    }

    function handleAck(event, which){
      event.preventDefault();

      alarmSound.pause();
      activeAlert = false;

      const card = document.getElementById(which === "op1" ? "alertOp1" : which === "op2" ? "alertOp2" : "alertOp3");
      card.style.opacity = "0.15";
      card.style.transform = "scale(0.98)";

      setTimeout(() => event.target.submit(), 400);
      return false;
    }

    function setCardsCounter(counter){
      document.querySelectorAll(".alert-card .cnt").forEach(span => span.innerText = counter);
      document.querySelectorAll(".alert-card .hiddenCounter").forEach(inp => inp.value = counter);
    }

    function showAlertsByCounter(counter, incident){
      const stack = document.getElementById("alertsStack");
      stack.style.display = "flex";

      const show1 = counter >= 1;
      const show2 = counter >= 4;
      const show3 = counter >= 7;

      resetOps();
      if (show1) document.getElementById("op1").classList.add("op-active");
      if (show2) document.getElementById("op2").classList.add("op-active");
      if (show3) document.getElementById("op3").classList.add("op-active");

      const op1 = document.getElementById("alertOp1");
      const op2 = document.getElementById("alertOp2");
      const op3 = document.getElementById("alertOp3");

      const hide1 = sessionStorage.getItem(`hide_${incident.id}_op1`) === "1";
      const hide2 = sessionStorage.getItem(`hide_${incident.id}_op2`) === "1";
      const hide3 = sessionStorage.getItem(`hide_${incident.id}_op3`) === "1";

      op1.style.display = (show1 && !hide1) ? "block" : "none";
      op2.style.display = (show2 && !hide2) ? "block" : "none";
      op3.style.display = (show3 && !hide3) ? "block" : "none";
    }

    function hideAllAlerts(){
      document.getElementById("alertsStack").style.display = "none";
      document.getElementById("alertOp1").style.display = "none";
      document.getElementById("alertOp2").style.display = "none";
      document.getElementById("alertOp3").style.display = "none";
      resetOps();
    }

    function maybeSendWhatsApp(incident, t){
      const key = "wa_sent_map";
      const map = JSON.parse(localStorage.getItem(key) || "{}");
      const id = incident.id;

      if (!map[id]) map[id] = { lvl1:false, lvl2:false, lvl3:false };

      const counter = incident.counter || 0;

      if (counter >= 1 && !map[id].lvl1){
        sendWhatsApp(`Alerte Niveau 1. Op√©rateur demand√©. T=${t.toFixed(1)}¬∞C`);
        map[id].lvl1 = true;
      }
      if (counter >= 4 && !map[id].lvl2){
        sendWhatsApp(`Alerte Niveau 2. Chef demand√©. T=${t.toFixed(1)}¬∞C`);
        map[id].lvl2 = true;
      }
      if (counter >= 7 && !map[id].lvl3){
        sendWhatsApp(`URGENCE. DIRECTEUR. T=${t.toFixed(1)}¬∞C`);
        map[id].lvl3 = true;
      }

      localStorage.setItem(key, JSON.stringify(map));
    }

    function checkState(t, mute, incident){
      const bot = document.getElementById("robot");

      bot.classList.remove("robot-alert","robot-cold","robot-frozen-ack");
      body.classList.remove("body-alert","body-cold");

      if (!incident || !incident.active){
        hideAllAlerts();
        document.getElementById("ackBanner").style.display = "none";
        if (activeAlert){ activeAlert = false; alarmSound.pause(); }
        hideBubble();
        return;
      }

      currentIncidentId = incident.id;
      const outOfRange = (t < MIN_OK || t > MAX_OK);

      if (mute){
        hideAllAlerts();

        const hideAck = sessionStorage.getItem(`hide_ack_${incident.id}`) === "1";
        if (!hideAck){
          document.getElementById("ackBy").innerText = incident.ack_by || "un op√©rateur";
          document.getElementById("ackBanner").style.display = "block";
        } else {
          document.getElementById("ackBanner").style.display = "none";
        }

        if (activeAlert){ activeAlert = false; alarmSound.pause(); }

        if (t < MIN_OK){
          body.classList.add("body-cold");
          bot.classList.add("robot-frozen-ack");
          showBubble("ü•∂ Acquitt√©", "#3498db");
        } else {
          body.classList.add("body-alert");
          bot.classList.add("robot-alert");
          showBubble("‚úÖ Acquitt√©", "#e74c3c");
        }
        return;
      }

      document.getElementById("ackBanner").style.display = "none";

      if (outOfRange){
        setCardsCounter(incident.counter || 0);

        const txt = (t > MAX_OK)
          ? `Temp√©rature TROP HAUTE (>8¬∞C) ‚Äî T=${t.toFixed(1)}¬∞C`
          : `Temp√©rature TROP BASSE (<2¬∞C) ‚Äî T=${t.toFixed(1)}¬∞C`;

        document.getElementById("statusOp1").innerText = txt;
        document.getElementById("statusOp2").innerText = txt;
        document.getElementById("statusOp3").innerText = txt;

        showAlertsByCounter(incident.counter || 0, incident);

        if (!activeAlert){
          activeAlert = true;
          alarmSound.play().catch(()=>{});
        }

        if (t > MAX_OK){ body.classList.add("body-alert"); bot.classList.add("robot-alert"); }
        else { body.classList.add("body-cold"); bot.classList.add("robot-cold"); }

        maybeSendWhatsApp(incident, t);
      } else {
        hideAllAlerts();
        if (activeAlert){ activeAlert = false; alarmSound.pause(); }
        hideBubble();
      }
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    /* ‚úÖ IMPORTANT: credentials same-origin pour CSRF */
    function toggleAlarm(){
      fetch(TOGGLE_ALARM_URL, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ action: "toggle" })
      })
      .then(r => r.json().catch(()=> ({})))
      .then(()=> update())
      .catch(()=>{});
    }

    function setNet(ok){
      netDot.classList.remove("ok","bad","warn");
      if (ok === true){
        netDot.classList.add("ok");
        netText.innerText = "Connexion: OK";
      } else {
        netDot.classList.add("bad");
        netText.innerText = "Connexion: ERREUR";
      }
    }

    function setAlarm(mute){
      alarmDot.classList.remove("ok","bad","warn");
      if (mute){
        alarmDot.classList.add("warn");
        alarmText.innerText = "Alarme: COUP√âE";
      } else {
        alarmDot.classList.add("ok");
        alarmText.innerText = "Alarme: ACTIVE";
      }
    }

    function update(){
      fetch(API_URL, { credentials: "same-origin" })
        .then(r => r.json())
        .then(data => {
          setNet(true);

          const t = data.temperature ? parseFloat(data.temperature) : 0;
          const h = data.humidity ? parseFloat(data.humidity) : 0;
          const mute = !!data.alarme_coupee;
          const incident = data.incident || {active:false};

          document.getElementById("temp").innerText = t.toFixed(1);
          document.getElementById("hum").innerText = h.toFixed(0);

          setAlarm(mute);

          const now = new Date();
          lastUpdate.innerText = now.toLocaleTimeString("fr-FR");

          checkState(t, mute, incident);
        })
        .catch(()=> setNet(false));
    }

    setInterval(update, 2000);
    update();

    function openMenu(){
      document.getElementById("sideMenu").classList.add("open");
      document.getElementById("menuBackdrop").style.display = "block";
    }
    function closeMenu(){
      document.getElementById("sideMenu").classList.remove("open");
      document.getElementById("menuBackdrop").style.display = "none";
    }

    /* ‚úÖ Bonus: fermer le menu apr√®s clic */
    document.querySelectorAll("#sideMenu a").forEach(a => {
      a.addEventListener("click", closeMenu);
    });
  </script>
</body>
</html>
